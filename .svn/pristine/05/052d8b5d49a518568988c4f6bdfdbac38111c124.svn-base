package kr.or.warehouse.controller.view;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.ModelAndView;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import kr.or.warehouse.command.Criteria;
import kr.or.warehouse.command.MakeFileName;
import kr.or.warehouse.controller.rest.GetAttachesByMultipartFileAdatpter;
import kr.or.warehouse.dto.AttachVO;
import kr.or.warehouse.dto.CooperReqVO;
import kr.or.warehouse.dto.DepartmentVO;
import kr.or.warehouse.dto.EmployeeVO;
import kr.or.warehouse.dto.MenuVO;
import kr.or.warehouse.dto.ObjectionVO;
import kr.or.warehouse.dto.ProxyReqVO;
import kr.or.warehouse.dto.ReportVO;
import kr.or.warehouse.dto.WorkVO;
import kr.or.warehouse.service.DepartMentService;
import kr.or.warehouse.service.WorkService;

@Controller
@RequestMapping("/work")
public class WorkController {
	@Autowired
	private WorkService workService;

	@Autowired
	private DepartMentService depService;

	@Resource(name="fileUploadPath")
	private String fileUploadPath;

	@RequestMapping("/main")
	public String main(Model model) throws Exception{
		String url = "work/main";

		return url;
	}

	/**
	 * 내 업무리스트 출력(동기화)
	 * @param model
	 * @param cri -> pagination 설정정보(페이지:page, 한 페이지에 보여줄 데이터 수:perPageNum, 검색카테고리:searchType, 검색키워드:keyword)
	 * @param statusNo -> 업무 상태(0:대기, 1:진행, 2:완료, 3:이의신청, 4:협업요청, 5:대리요청, 6:전체)
	 * @return String model에 데이터를 심어서 보낼 화면 url
	 * @throws Exception
	 */
	@RequestMapping("/myWorkList")
	public String myWorkList(Model model, Criteria cri, @RequestParam(defaultValue = "0") int statusNo, HttpSession session) throws Exception{
		String url = "work/myWorkList";

		EmployeeVO loginUser = (EmployeeVO)session.getAttribute("loginUser");
		cri.setPerPageNum(5);
		Map<String, Integer> noneCheckCnt = null;
		noneCheckCnt = workService.getNoneCheckCnt("M113000",cri,loginUser.getEno(), loginUser.getDno());
		Map<String, Object> dataMap = workService.getMyWorkList(cri, statusNo,loginUser.getEno());

		System.out.println(dataMap.get("pageMaker"));
		model.addAttribute("dataMap", dataMap);
		model.addAttribute("noneCheckCnt", noneCheckCnt);

		return url;
	}

	/**
	 * 내가 요청한 업무리스트 출력(동기화)
	 * @param model
	 * @param cri -> pagination 설정정보(페이지:page, 한 페이지에 보여줄 데이터 수:perPageNum, 검색카테고리:searchType, 검색키워드:keyword)
	 * @param statusNo -> 업무 상태(0:대기, 1:진행, 2:완료, 3:이의신청, 4:협업요청, 5:대리요청, 6:전체)
	 * @return String model에 데이터를 심어서 보낼 화면 url
	 * @throws Exception
	 */
	@RequestMapping("/toReqList")
	public String toReqList(Model model, Criteria cri, @RequestParam(defaultValue = "0") int statusNo, HttpSession session) throws Exception{
		String url = "work/toReqList";

		EmployeeVO loginUser = (EmployeeVO)session.getAttribute("loginUser");
		cri.setPerPageNum(5);
		Map<String, Integer> noneCheckCnt = null;
		noneCheckCnt = workService.getNoneCheckCnt("M114000",cri,loginUser.getEno(), loginUser.getDno());
		Map<String, Object> dataMap = workService.getToReqList(cri, statusNo, loginUser.getEno());

		model.addAttribute("dataMap", dataMap);
		model.addAttribute("noneCheckCnt", noneCheckCnt);

		return url;
	}

	/**
	 * 부서 목록 출력(동기화)
	 * @param model
	 * @param cri -> pagination 설정정보(페이지:page, 한 페이지에 보여줄 데이터 수:perPageNum, 검색카테고리:searchType, 검색키워드:keyword)
	 * @param statusNo -> 업무 상태(0:대기, 1:진행, 2:완료, 3:이의신청, 4:협업요청, 5:대리요청, 6:전체)
	 * @return String model에 데이터를 심어서 보낼 화면 url
	 * @throws Exception
	 */
	@RequestMapping("/depWorkList")
	public String depWorkList(Model model, Criteria cri, @RequestParam(defaultValue = "0") int statusNo, HttpSession session) throws Exception{
		String url = "work/depWorkList";

		EmployeeVO loginUser = (EmployeeVO)session.getAttribute("loginUser");
		cri.setPerPageNum(5);
		Map<String, Integer> noneCheckCnt = null;
		noneCheckCnt = workService.getNoneCheckCnt("M115000",cri,loginUser.getEno(), loginUser.getDno());
		Map<String, Object> dataMap = workService.getDepWorkList(cri, statusNo, loginUser.getEno(), loginUser.getDno());

		model.addAttribute("dataMap", dataMap);
		model.addAttribute("noneCheckCnt", noneCheckCnt);

		return url;
	}

	@RequestMapping("/declareList")
	public String declareList() throws Exception{
		String url = "work/declareList";

		return url;
	}

	//대기중 상세
	@RequestMapping("/waitDetail")
	public String waitDetail(@RequestHeader Map<String, Object> requestHeader, @RequestParam String wcode, Model model, HttpSession session) throws Exception{
		String url = "work/waitDetail";

		String refer = requestHeader.get("referer").toString();
		String referMcode = refer.substring(refer.lastIndexOf("=") + 1);
		if(referMcode.contains("M113")) {
			model.addAttribute("refer", referMcode);
			ObjectionVO objection = workService.getObjection(wcode);
			if(objection != null) {
				model.addAttribute("objection", objection);
			}else {
				model.addAttribute("objection", null);
			}
		}else if(referMcode.contains("M114")) {
			model.addAttribute("refer", referMcode);
			ObjectionVO objection = workService.getObjection(wcode);
			if(objection != null) {
				model.addAttribute("objection", objection);
			}else {
				model.addAttribute("objection", null);
			}
		}else if(referMcode.contains("M115")){
			model.addAttribute("refer",referMcode);
			ObjectionVO objection = workService.getObjection(wcode);
			if(objection != null) {
				model.addAttribute("objection", objection);
			}else {
				model.addAttribute("objection", null);
			}
		}

		EmployeeVO loginUser = (EmployeeVO)session.getAttribute("loginUser");
		WorkVO work = workService.getWorkByWcode(wcode, loginUser.getEno());
		System.out.println(work);
		model.addAttribute("work", work);
		model.addAttribute("loginUser", loginUser);
		return url;
	}

	//진행중 상세
	@RequestMapping(value = "/workDetailGo", method=RequestMethod.GET)
	public String workDetailGo(@RequestHeader Map<String, Object> requestHeader, @RequestParam String wcode, Model model, HttpSession session) throws Exception{
		String url = "work/workDetail";

		String refer = requestHeader.get("referer").toString();
		String referMcode = refer.substring(refer.lastIndexOf("=") + 1);
		EmployeeVO loginUser = (EmployeeVO)session.getAttribute("loginUser");
		System.out.println("referMcode : " + referMcode);
		if(referMcode.contains("M113")) {
			model.addAttribute("refer", referMcode);
			CooperReqVO cooperReq = workService.getCooperReq(wcode);
			ObjectionVO objection = workService.getObjection(wcode);
			ProxyReqVO proxyReq = workService.getProxyReq(wcode);
			if(cooperReq != null) {
				model.addAttribute("cooperReq", cooperReq);
			}
			if(objection != null) {
				model.addAttribute("objection", objection);
			}
			if(proxyReq != null) {
				model.addAttribute("proxyReq", proxyReq);
			}
		}else if(referMcode.contains("M114")) {
			model.addAttribute("refer", referMcode);
			CooperReqVO cooperReq = workService.getCooperReq(wcode);
			ObjectionVO objection = workService.getObjection(wcode);
			ProxyReqVO proxyReq = workService.getProxyReq(wcode);
			if(cooperReq != null) {
				model.addAttribute("cooperReq", cooperReq);
			}
			if(objection != null) {
				model.addAttribute("objection", objection);
			}
			if(proxyReq != null) {
				model.addAttribute("proxyReq", proxyReq);
			}
		}else if(referMcode.contains("M115")){
			model.addAttribute("refer",referMcode);
			CooperReqVO cooperReq = workService.getCooperReq(wcode);
			ObjectionVO objection = workService.getObjection(wcode);
			ProxyReqVO proxyReq = workService.getProxyReq(wcode);
			if(cooperReq != null) {
				model.addAttribute("cooperReq", cooperReq);
			}
			if(objection != null) {
				model.addAttribute("objection", objection);
			}
			if(proxyReq != null) {
				model.addAttribute("proxyReq", proxyReq);
			}
		}

		WorkVO work = workService.getWorkByWcode(wcode, loginUser.getEno());
		System.out.println(work);
		model.addAttribute("work", work);
		model.addAttribute("loginUser", loginUser);

		return url;
	}

	//노하우상세
	@RequestMapping("/workDetail")
	public String workDetail(@RequestHeader Map<String, Object> requestHeader, Model model) throws Exception{
		String url = "work/workDetail";

		String refer = requestHeader.get("referer").toString();
		String referMcode = refer.substring(refer.indexOf("=") + 1);

		if(referMcode.contains("M13")) {
			model.addAttribute("refer", "knowhow");
		}

		return url;
	}

	@RequestMapping("/reportRegistForm")
	public String reportRegistForm(String wcode, HttpSession session, Model model) throws Exception{
		String url = "work/reportRegistForm";

		EmployeeVO loginUser = (EmployeeVO)session.getAttribute("loginUser");
		model.addAttribute("wcode", wcode);
		model.addAttribute("loginUser", loginUser);

		return url;
	}

	@RequestMapping("/proceedRegistForm")
	public String proceedRegistForm() throws Exception{
		String url = "work/proceedRegistForm";

		return url;
	}

	@RequestMapping("/toReqWorkDetailGo")
	public String toReqWorkDetail() throws Exception{
		String url = "work/toReqWorkDetail";

		return url;
	}

	@RequestMapping("/workRegistForm")
	public String workRegistForm() throws Exception{
		String url = "work/workRegistForm";

		return url;
	}

	@RequestMapping(value = "/toReqModifyGo", method=RequestMethod.GET)
	public String myWorkModify(@RequestHeader Map<String, Object> requestHeader, String wcode, Model model, HttpSession session) throws Exception{
		String url = "work/workModifyForm";

		EmployeeVO loginUser = (EmployeeVO)session.getAttribute("loginUser");
		String refer = requestHeader.get("referer").toString();
		String referMcode = refer.substring(refer.lastIndexOf("=") + 1);

		WorkVO work = workService.getWorkByWcode(wcode, loginUser.getEno());
		List<DepartmentVO> departMentList = depService.getDepartMentList();
		List<OrganizationNode> organizationNode = workService.organization(departMentList);

		System.out.println("referMcode : " + referMcode);
		if(referMcode.contains("M114")) {
			model.addAttribute("refer", referMcode);
			model.addAttribute("organizationNode", organizationNode);
			CooperReqVO cooperReq = workService.getCooperReq(wcode);
			ObjectionVO objection = workService.getObjection(wcode);
			ProxyReqVO proxyReq = workService.getProxyReq(wcode);
			if(objection != null) {
				model.addAttribute("objection", objection);
			}
			if(cooperReq != null) {
				model.addAttribute("cooperReq", cooperReq);
			}
			if(proxyReq != null) {
				model.addAttribute("proxyReq", proxyReq);
			}
		}else if(referMcode.contains("M115")){
			model.addAttribute("refer",referMcode);
			model.addAttribute("organizationNode", organizationNode);
			CooperReqVO cooperReq = workService.getCooperReq(wcode);
			ObjectionVO objection = workService.getObjection(wcode);
			ProxyReqVO proxyReq = workService.getProxyReq(wcode);
			if(objection != null) {
				model.addAttribute("objection", objection);
			}
			if(cooperReq != null) {
				model.addAttribute("cooperReq", cooperReq);
			}
			if(proxyReq != null) {
				model.addAttribute("proxyReq", proxyReq);
			}
		}


		model.addAttribute("work", work);
		return url;
	}

	@RequestMapping(value = "reportRegist", method=RequestMethod.POST)
	public String reportRegist(ReportVO report, RedirectAttributes rttr, HttpServletRequest request) throws Exception{
		String url = "redirect:/work/myWorkList.do";

		String uploadPath = fileUploadPath;
		List<AttachVO> attach = GetAttachesByMultipartFileAdatpter.save(report.getUploadFile(), uploadPath);
		if(attach != null && attach.size() > 0) {
			report.setFileName(attach.get(0).getFileName());
			report.setUploadPath(uploadPath);
		}
		report.setTitle((String)request.getAttribute("XSStitle"));

		workService.reportRegist(report);
		rttr.addFlashAttribute("from", "reportRegist");

		return url;
	}

	@RequestMapping("/getReportDetail")
	public String getReportDetail(int repno, Model model) throws Exception{
		String url = "work/reportDetail";

		ReportVO report = workService.getReportByRepNo(repno);
		String fileName = report.getFileName();
		String parseFileNameFromUUID = MakeFileName.parseFileNameFromUUID(fileName, "\\$\\$");
		report.setFileName(parseFileNameFromUUID);
		model.addAttribute("report", report);

		return url;
	}

	@RequestMapping("/getReportFile.do")
	public String getReportFile(int repno, Model model) throws Exception{
		String url ="downloadFile";

		ReportVO report = workService.getReportByRepNo(repno);
		String fileName = report.getFileName();
		String uploadPath = report.getUploadPath();
		model.addAttribute("fileName", fileName);
		model.addAttribute("savedPath", uploadPath);

		return url;
	}
}
